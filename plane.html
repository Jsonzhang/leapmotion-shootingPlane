<!doctype html>
<html>
	<head>
		<meta charset="utf-8" />
		<title></title>
		<style>
			canvas{border:1px solid #000;}
			body{text-align:center}
		</style>
		<script src="script/windowTocanvas.js"></script>
		<script src="script/bgSprite.js"></script>
		<script src="script/Sprite.js"></script>
		<script src="script/Enemy.js"></script>
		<script src="script/plane.js"></script>
		<script src="script/Bullet.js"></script>

		<script src="script/leap.min.js"></script>
	  
	</head>
	<body>
		<canvas id="canvas" width="320" height="568">浏览器不支持</canvas>
		 <script>
	      var pausedFrame = null;
	      var latestFrame = null;
	      
	      



			var canvas=document.getElementById('canvas');
			var context=canvas.getContext('2d');
			
			
			//创建对象集合 （集合所有精灵）
			var sprites=[];
					
			//创建我方飞机
			var plane=createPlane();
			//讲我方飞机添加到精灵对象集合中
			sprites.push(plane);
					
			//添加飞机计时变量  用于记录飞机出现的时间
			var smallEnemyTime=0;//记录最后一次小飞机出现的时间
			var middleEnemyTime=0;//记录最后一次中飞机出现的时间
			var bigEnemyTime=0;//记录最后一次大飞机出现的时间
			var bulletTime=0;//记录最后一次子弹出现的时间
			
			//声明积分变量
			var score=0;
			
			
			var controller = new Leap.Controller({enableGestures: true});
		      controller.loop(function(frame) {
		        latestFrame = frame;


		        if(latestFrame.pointables[0]){
		        		point = {
		        			x : (latestFrame.pointables[0].tipPosition[0] + 350) * canvas.width / 700,
		        			y : (700 - latestFrame.pointables[0].tipPosition[1]) * canvas.height / 700
		        		}
		        			
						plane.left=point.x-plane.width/2;
						plane.top=point.y-plane.height/2;
		        }



		      });
			

			
			function animate(time){

				//添加飞机操作
				//小飞机添加
				if(time-smallEnemyTime>1500){
					//一次性添加三个小飞机
					for(var i=0;i<3;i++){
						sprites.push(createEnemy('smallEnemy'));
					}
					//更新最后一次记录时间
					smallEnemyTime=time;	
	
				}
				
				//添加中飞机
				if(time-middleEnemyTime>3000){
					//添加中飞机
					sprites.push(createEnemy('middleEnemy'));
					sprites.push(createEnemy('middleEnemy'));
					//更新最后一次记录时间
					middleEnemyTime=time;
				}
				
				//添加大飞机
				if(time-bigEnemyTime>10000){
					//添加中飞机
					sprites.push(createEnemy('bigEnemy'));
					//更新最后一次记录时间
					bigEnemyTime=time;
				}
				
				//添加子弹
				if(time-bulletTime>200){
					sprites.push(createBullet(plane.left+plane.width/2,plane.top-15));
					bulletTime=time;
				}
				
				
				
				
				//更新当前背景的位置
				bgSprite.update(context,time);
				//绘制背景
				bgSprite.paint(context);
				
				//循环遍历所有精灵对象 更新行为
				for(var i=0;i<sprites.length;i++){
					sprites[i].update(context,time);
					
					
					//判断是否有不可见的精灵对象
					if(sprites[i].visible==false){
						//在飞机对象删除之前把分数累加起来
						if(sprites[i].name!='bullet' && sprites[i].name!='plane' ){//判断是否是飞机
							score=score+sprites[i].score;
						}
						
						//删除不可见的对象
						sprites.splice(i,1);
					}	
				}
				//循环遍历所有精灵对象 绘制对象
				for(var i=0;i<sprites.length;i++){
					//判断子弹是否击中敌机
					if(sprites[i].name=='bullet'){
						for(var j=0;j<sprites.length;j++){
							//挑选不是子弹和我方飞机的对象(三种敌机)
							if(sprites[j].name!='bullet' && sprites[j].name!='plane'){
								//判断子弹和每个敌机的位置
								//子弹的横坐标>飞机左侧位置
								if(sprites[i].left>sprites[j].left &&
									//子弹的横坐标<飞机右侧位置（右侧=左侧+宽度）
									sprites[i].left<sprites[j].left+sprites[j].width &&
									//子弹的纵坐标>顶部位置
									sprites[i].top>sprites[j].top &&
									//子弹纵坐标<底部位置
									sprites[i].top<sprites[j].top + sprites[j].height - 30){
								
									//只有飞机气血>=1的情况下才减血
									if(sprites[j].hp>=1){
										//讲当前飞机的气血-1
										sprites[j].hp-=1;
										//讲当前子弹变为不可见状态
										sprites[i].visible=false;
									}
									
								
								}
							
							}
						}
					}
					var leftvalue,topvalue;
					if(sprites[i].name=='plane'){
						for(j=0;j<sprites.length;j++){
							if(sprites[j].name!='bullet' && sprites[j].name!='plane'){
								leftvalue = sprites[i].left - sprites[j].left;
								if(leftvalue < 0){
									leftvalue = Math.abs(leftvalue) < sprites[i].width - 20 ? true : false;
								}else{
									leftvalue = Math.abs(leftvalue) < sprites[j].width - 20 ? true : false;
								}


								topvalue = sprites[i].top - sprites[j].top;
								if(topvalue < 0){
									topvalue = Math.abs(topvalue) < sprites[i].height - 20 ? true : false;
								}else{
									topvalue = Math.abs(topvalue) < sprites[j].height - 20 ? true : false;
								}

								if( leftvalue && topvalue){
									sprites[i].hp = 0 ;
									// return false;
								}
							}
						}
					}
					sprites[i].paint(context);
				}
				
				
				context.font='26px microsoft ';
				context.fillText('总分:'+score,170,30);
				
				//帧率计算
				//再次调用绘制动画方法
				window.requestAnimationFrame(animate);
			}
			
			window.requestAnimationFrame(animate);
			
		</script>
	</body>
</html>